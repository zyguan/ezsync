#!/usr/bin/env bash

bin=`dirname "${BASH_SOURCE-$0}"`
bin=`cd "$bin"; pwd`

# set default config
DST="/tmp"
HOSTS="localhost"

# load config
if [[ -s "./.ezsync.conf" ]]; then
    source "./.ezsync.conf"
elif [[ -s "$HOME/.ezsync.conf" ]]; then
    source "$HOME/.ezsync.conf"
elif [[ -s "$bin/.ezsync.conf" ]]; then
    source "$bin/.ezsync.conf"
else
    echo "WARN: couldn't load .ezsync.conf, use $HOSTS:$DST."
fi

SRC=$(readlink -f $(pwd)/$SRC)

[[ -f $SRC/.rsync-filter ]] && FILTER_OPT="-F $SRC/.rsync-filter"

for host in ${HOSTS}; do
    if [ -z $DEBUG ]; then
        echo "sync: $SRC => $host:$DST"
        rsync -az $FILTER_OPT $ARGS $@ --rsync-path="mkdir -p $DST && rsync" $SRC/ $host:$DST
    else
        echo "DEBUG: rsync -az $FILTER_OPT $ARGS $@ $SRC/ $host:$DST"
    fi
done
